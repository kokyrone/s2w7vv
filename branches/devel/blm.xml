<?xml version="1.0" ?>
<!-- Balakir's BLM spellcast, based on Aikairs -->
<spellcast>
	<config 
	RequireVersion="2.22"
	ShowGearSwaps="false"
	Debug="True"
	/>
	<variables>
		<!-- Sleep timers, announces to chat when sleep is wearing off. Set to 0 to not use. -->
		<!-- (note: this is sort of very obvious usage of 3rd party programs, so turn off when around people you dont trust -->
		<var name="SleepTimers">0</var>
		<!-- use BLM AF2 pants or not? Set to 0 if you do not have it -->
		<var name="BLMAF2Pants">1</var>
		<!-- use Sorc ring or not? set to 0 if you do not have it or dangerous location -->
		<var name="Ring">0</var>
		<!-- use Ugg Pendant or not? set to 0 if you do not have it. -->
		<var name="UggPendant">0</var>
		<!-- Elemental Grips, set to 1 for each you have -->
		<var name="LightGrip">0</var>
		<var name="DarkGrip">1</var>
		<var name="ThunderGrip">1</var>
		<var name="IceGrip">1</var>
		<var name="FireGrip">0</var>
		<var name="WindGrip">0</var>
		<var name="WaterGrip">0</var>
		<var name="EarthGrip">0</var>
		<!-- Elemental Staffs, input what staff to use for each element here -->
		<var name="IceStaff">Aquilo's Staff</var>
		<var name="DarkStaff">Pluto's Staff</var>
		<var name="ThunderStaff">Jupiter's Staff</var>
		<var name="WindStaff">Wind Staff</var>
		<var name="FireStaff">Fire Staff</var>
		<var name="EarthStaff">Earth Staff</var>
		<var name="LightStaff">Light Staff</var>
		<var name="WaterStaff">Water Staff</var>
		<!-- Elemental Obi's, set to 1 for the ones you have. -->
		<var name="DarkObi">0</var>
		<var name="LightObi">0</var>
		<var name="ThunderObi">0</var>
		<var name="IceObi">0</var>
		<var name="FireObi">0</var>
		<var name="WindObi">0</var>
		<var name="WaterObi">0</var>
		<var name="EarthObi">0</var>
		<!-- Resist Mob Variables -->
		<var name="HighResist">Tiamat|Genbu|Suzaku|Seiryu|Byakko|Kirin|Jormungand|Vrtra|Cerberus|Khimaira|Tyger|Jailer of Love|Sarameya|Proto-Ultima|Kindred*|Vanguard*</var>
		<var name="MidResist">Fafnir|Nidhogg|Aspidochelone|King Behemoth|Tinnin|Ouryu|Kaiser Behemoth</var>
		<var name="LightResist">Lambton Worm|Sandworm|Guivre|King Arthro|Serket</var>
		<!-- Nation control check for MC Bracelets, macro //sc var set nccheck 1 for true //sc var set nccheck 0 for false -->
		<var name="nccheck">0</var>
	</variables>
	<sets>
		<group name="Main" default="yes">
			<set name="Standard">
				<main>$EarthStaff</main>
				<sub>Bugard Strap +1</sub>
				<ammo>Phantom Tathlum</ammo>
				<head>Wizard's Petasos</head>
				<neck>Elemental Torque</neck>
				<lear>Moldavite Earring</lear>
				<rear>Phantom Earring</rear>
				<body>Sorcerer's Coat</body>
				<hands>Wizard's Gloves</hands>
				<lring>Diamond Ring</lring>
				<rring>Diamond Ring</rring>
				<back>Hecate's Cape</back>
				<waist>Penitent's Rope</waist>
				<legs>Mahatma Slops</legs>
				<feet>Cobra Crackows</feet>
			</set>
			<set name="FastCast">
			<!--
				<feet>Rostrum Pumps</feet>
				<rear>Loquac. Earring</rear>
				-->
			</set>
			<set name="Resting" BaseSet="Standard">
				<main>$DarkStaff</main>
				<sub>Ariesian Grip</sub>
				<head>Cobra Hat</head>
				<neck>Beak Necklace +1</neck>
				<lear>Antivenom Earring</lear>
				<body>Errant Hpl.</body>
				<!--<back>Cortege Cape</back>-->
				<waist>Qiqirn Sash +1</waist>
				<!--<legs>Baron's Slops</legs>
				<feet>Goliard Clogs</feet>-->
			</set>
			<set name="MinusHP">
				<sub>Thunder Grip</sub>
				<head>Zenith Crown</head>
				<neck>Morgana's Choker</neck>
				<lring>Serket Ring</lring>
				<legs>Zenith Slacks</legs>
				<feet>Rostrum Pumps</feet>
			</set>
			<set name="FullDamage" BaseSet="Standard">
				<body>Igqira Weskit</body>
			</set>
			<set name="HighResist" BaseSet="FullDamage">
				<head>Sorcerer's Petas.</head>
				<feet>Sorcerer's Sabots</feet>
			</set>
			<set name="MidResist" BaseSet="FullDamage">
				<head>Sorcerer's Petas.</head>
			</set>			
			<set name="LightResist" BaseSet="FullDamage">
				<head>Sorcerer's Petas.</head>
			</set>					
			<set name="DarkMagic">
				<hands>Sorcerer's Gloves</hands>
				<legs>Wizard's Tonban</legs>
			</set>
			<set name="EnfeeblingMagic">
				<head>Igqira Tiara</head>
				<neck>Enfeebling Torque</neck>
				<body>Wizard's Coat</body>
				<waist>Witch Sash</waist>
				<legs>Igqira Lappa</legs>
			</set>
			<set name="Eledebuff"  BaseSet="Standard">
				<main lock="yes">Kirin's Pole</main>
				<body>Errant Hpl.</body>
				<back>Rainbow Cape</back>
				<legs>Mahatma Slops</legs>
				<feet>Sorcerer's Sabots</feet>
			</set>
			<set name="HealingMagic" />
			<set name="DivineMagic" />
			<set name="EnhancingMagic" BaseSet="Standard">
				<main lock="yes">$WaterStaff</main>
				<sub>Raptor Strap +1</sub>
				<neck>Promise Badge</neck>
				<body>Errant Hpl.</body>
				<lring>Sapphire Ring</lring>
				<rring>Sapphire Ring</rring>
				<back>Rainbow Cape</back>
				<legs>Mahatma Slops</legs>
				<feet>Cobra Crackows</feet>
			</set>
		</group>
		<group name="Melee">
			<set name="Standard">
				<main lock="yes">Garuda's Dagger</main>
				<sub lock="Yes">Genbu's Shield</sub>
				<ammo>Phtm. Tathlum</ammo>
				<head>Igqira Tiara</head>
				<neck>Beak Necklace +1</neck>
				<lear></lear>
				<rear></rear>
				<body>Sorcerer's Coat</body>
				<hands>Sorcerer's Gloves</hands>
				<lring>Jelly Ring</lring>
				<rring></rring>
				<back></back>
				<waist></waist>
				<legs>Igqira Lappa</legs>
				<feet>Goliard Clogs</feet>
			</set>
		</group>
	</sets>
	<rules>
		<!-- utility: if targetting a monster, but casting a spell that can not be cast on monsters, then cast on self (buffs). -->
		<if SpellTargetType="MONSTER" NotValidTarget="*Enemy*" ValidTarget="*Self*">
			<action type="changetarget" target="&lt;me&gt;" />
		</if>	
		<if SpellTargetType="NONE" ValidTarget="*Self*">
			<action type="changetarget" target="&lt;me&gt;" />
		</if>
		
		<!-- set of gear to equip when finished casting a spell or coming back from resting mp (idle set) -->
		<equip when="Idle|aftercast" set="Standard" />
		<!-- Equip town gears :) -->
		<xi:include href="inc.xml" xpointer="/includes/include[@name='TownSettings']/*" />
		<!-- set of gear to equip when resting -->
		<equip when="Resting" set="Resting" />
		<if Spell="Escape|Warp|Warp II|Retrace|Teleport-*|Reraise|Tractor">
			<equip when="Precast" set="FastCast" />
			<return />
		</if>
		<if Spell="Stun">
			<!-- equip gear that helps stun, and nothing else -->
			<equip set="FullDamage|DarkMagic|FastCast">
				<main lock="true">$ThunderStaff</main>
				<if Advanced='"$ThunderGrip" == "1"'>
					<equip when="midcast">
						<sub lock="true">Thunder Grip</sub>
					</equip>
				</if>
			</equip>
			<!-- these codes just print Stun in auto translate into chat. -->
			<action type="command">input /p \xFD\x07\x02\x12\xFC\xFD %SpellTarget</action>
		</if>
		<else>
			<!-- equip fast cast gear -->
			<equip when="precast" Set="FastCast" />
			<!-- Elemental Grip checks. Are we casting an enfeeble, or are we casting on a resistant mob? -->
			<if mode="OR" NotSkill="ElementalMagic" NotSpell="Frost|Drown|Rasp|Burn|Shock|Choke" SpellTargetName="$HighResist|$MidResist">
				<if Advanced='"$%SpellElementGrip" == "1"'>
					<equip when="midcast">
						<sub lock="true">%SpellElement Grip</sub>
					</equip>
				</if>
			</if>
			<!-- if were handling spells -->
			<if Skill="*Magic">
				<!-- if this is elemental magic (nukes/dot's, then do special handling -->
				<if Skill="ElementalMagic">
					<if Spell="Frost|Drown|Rasp|Burn|Shock|Choke">
						<!-- equip elemental/INT gear for DoT's -->
						<equip when="midcast" Set="Eledebuff" />	
					</if>
					<else>
					<action type="MidcastDelay" Delay="2.0" />
						<!-- this is an actual nuke. Check target to be a known high resist mob (and that ES is not active) -->
						<if SpellTargetName="$HighResist" NotBuffActive="Elemental Seal">
							<equip when="midcast" Set="HighResist" />	
						</if>
						<else>
							<!-- check for Sorc Ring if mid or low resist mob. An equip HP down if needed-->
							<if advanced='$Ring == 1'>
								<if HPPGT="74">
									<equip set="MinusHP" />
								</if>
							</if>
							<!-- if mob is not high resist, is it a mid resist mob? -->
							<if SpellTargetName="$MidResist" NotBuffActive="Elemental Seal">
								<equip when="midcast" Set="MidResist" />
							</if>
							<else>
								<!-- Normal mob, go full damage gear. -->
								<if mode="or" Area="Dynamis *|Hazhalm*" SpellTargetName="$LightResist">
									<if NotBuffActive="Elemental Seal">
										<equip when="midcast" Set="LightResist" />
									</if>
									<else>
										<equip when="midcast" Set="FullDamage" />	
									</else>
								</if>
								<else>
									<equip when="midcast" Set="FullDamage" />	
								</else>
								<!-- only equip pendant in situations you would equip full damage gear -->
								<if MLvlGT="69">
									<if MPPAfterCastLT="50" Advanced="$UggPendant==1">
										<equip when="midcast">
											<neck lock="yes">Uggalepih Pendant</neck>
										</equip>
									</if>
								</if>	
							</else>
							<!-- Equip Sorc Ring if mid or low resist mob.-->
							<if advanced='$Ring == 1'>
								<equip when="midcast">
									<lring lock="yes">Sorcerer's Ring</lring>
								</equip>
							</if>
						</else>
					</else>
				</if>
				<if Skill="EnfeeblingMagic">
					<if mode="OR" Area="Dynamis*|Al'Taieu|Grand Palace of Hu'Xzoi|The Garden of Ru'Hmet|Apollyon|Temenos" Advanced='"$nccheck" = "1"'>
						<equip type="equip" when="midcast" set="%skill">
							<hands>Mst.Cst. Bracelets</hands>
						</equip>
					</if>
					<else>
						<equip when="midcast" set="%Skill" />
					</else>
				</if>	
				<else>
						<!-- for any other type of spell, just equip matching set name. -->
						<equip when="midcast" Set="%Skill" />
				</else>
			</if>
			<else>
				<equip when="precast|midcast" Set="Standard" />
			</else>
			<!-- Handle Elemental Obi's -->
			<xi:include href="inc.xml" xpointer="/includes/include[@name='ObiRules']/*" />
			<!--<if Advanced='("%SpellElement" = "%WeatherElement" OR "%SpellElement" = "%DayElement") AND "$%SpellElementObi" = "1"'>
				<if	 Element="Dark"><equip when="midcast"><waist lock="yes">Anrin Obi</waist></equip></if>
				<elseif Element="Light"><equip when="midcast"><waist lock="yes">Korin Obi</waist></equip></elseif>
				<elseif Element="Thunder"><equip when="midcast"><waist lock="yes">Rairin Obi</waist></equip></elseif>
				<elseif Element="Ice"><equip when="midcast"><waist lock="yes">Hyorin Obi</waist></equip></elseif>
				<elseif Element="Fire"><equip when="midcast"><waist lock="yes">Karin Obi</waist></equip></elseif>
				<elseif Element="Wind"><equip when="midcast"><waist lock="yes">Furin Obi</waist></equip></elseif>
				<elseif Element="Water"><equip when="midcast"><waist lock="yes">Suirin Obi</waist></equip></elseif>
				<elseif Element="Earth"><equip when="midcast"><waist lock="yes">Dorin Obi</waist></equip></elseif>
			</if>-->
			<!-- Handle AFv2 Pants, but do not equip pants if we already have Weather x2 and day bonuses from obi alone as obi alone hits the 35% damage cap. -->
			<if Advanced='(!((bool)strmatch("* x2","%Weather") AND "%WeatherElement" = "%SpellElement" AND "$%SpellElementObi" = "1") OR !("%WeatherElement" = "%spellElement")) AND ("%SpellElement" = "%DayElement" AND "$BLMAF2Pants" = "1") AND ("%skill"="ElementalMagic")'>
				<equip when="midcast">
					<legs lock="yes">Sorcerer's Tonban</legs>
				</equip>
			</if>
			<!-- Timers for when sleep is wearing off. -->
			<if advanced='"$SleepTimers"="1"'>
				<if Spell="Sleep II|Sleepga II">
					<action type="command" when="aftercast">spellcast var inc sleepid;wait 45;input /p [$sleepid:%spell] &lt;%target&gt; Wearing off in 45s</action>
					<action type="command" when="aftercast">wait 75;input /p [$sleepid:%spell] &lt;%target&gt; Wearing off in 15s</action>
					<action type="command" when="aftercast">wait 85;input /p [$sleepid:%spell] &lt;%target&gt; Wearing off in 5s;spellcast var dec sleepid;</action>
				</if>
				<elseif Spell="Sleep|Sleepga">
					<action type="command" when="aftercast">spellcast var inc sleepid;wait 45;input /p [$sleepid:%spell] &lt;%target&gt; Wearing off in 15s</action>
					<action type="command" when="aftercast">wait 55;input /p [$sleepid:%spell] &lt;%target&gt; Wearing off in 5s;spellcast var dec sleepid;</action>
				</elseif>
			</if>
			<!-- auto cancel sneak/utsu/stoneskin/blink when recasting them. Requires Cancel Plugin -->
			<xi:include href="inc.xml" xpointer="/includes/include[@name='CancelRules']/*" />
			<!-- finally, equip our staff! -->
			<equip when="midcast">
				<main>$%SpellElementStaff</main>
			</equip>
		</else>
	</rules>
</spellcast>
